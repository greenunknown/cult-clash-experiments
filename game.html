<!doctype html> 
<html lang="en"> 
<head> 
    <meta charset="UTF-8" />
    <title>Making your first Phaser 3 Game - Part 9</title>
    <script src="//cdn.jsdelivr.net/npm/phaser@3.11.0/dist/phaser.js"></script>
    <script src="matter.js"></script>
    <style type="text/css">
        body {
            margin: 0;
        }
    </style>
</head>
<body>

<script type="text/javascript">
    var config = {
        type: Phaser.AUTO,
        width: 800,
        height: 600,
        backgroundColor: '#3bf7cf',
        parent: 'phaser-example',
        physics: {
            default: 'matter',
            matter: {
                gravity: {
                    x: 0,
                    y: 1 // Produces an arch with y: 1
                },
                debug: true
            }
        },
        scene: {
            preload: preload,
            create: create//,
            //update: update
        }
    };

    var game = new Phaser.Game(config);
    var lookLeft = false;
    var holding = false;
    var canGrab = false;
    var jump = false;

    function preload ()
    {
        this.load.image('sky', 'assets/sky.png');
        this.load.image('ground', 'assets/platform.png');
        this.load.image('star', 'assets/star.png');
        this.load.image('bomb', 'assets/bomb.png');
        this.load.spritesheet('dude', 'assets/dude.png', { frameWidth: 32, frameHeight: 48 });
    }

    function create ()
    {
        console.log(game.config.width, game.config.height);
        this.matter.world.setBounds(0, 0, game.config.width, game.config.height);
        //var blockA = this.matter.add.image(0, 300, 'star').setBounce(1).setFriction(0);
        //var blockB = this.matter.add.sprite(600, 300, 'star').setStatic(true);
        var player = this.matter.add.sprite(100, 400, 'dude', 5).setFixedRotation();
        var rune = this.matter.add.sprite(350, 500, 'star').setTint("#ffffff").setFixedRotation().setStatic(true);
        var ground = this.matter.add.image(0, 500, 'ground').setScale(3);
        var playerVel = {x: 0, y: 0};
        //this.matter.add.image(0, 0, 'sky').setOrigin(0, 0);

        var groundCat = this.matter.world.nextCategory();
        var playerCat = this.matter.world.nextCategory();
        var runeCat = this.matter.world.nextCategory();
        ground.setCollisionCategory(groundCat);
        player.setCollisionCategory(playerCat);
        rune.setCollisionCategory(runeCat);
        player.setCollidesWith([playerCat, groundCat, runeCat]);
        

        //blockA.setVelocityX(10);

        this.matter.world.on('collisionstart', function(event, bodyA, bodyB) {
           jump = false; 


            console.log(event);
            console.log(bodyA);
            console.log(bodyB);
           if(bodyA.gameObject === player && bodyB.gameObject === rune)
           {
                canGrab = true;
                console.log("Player collides with rune")
           }
           else {
               canGrab = false;
           }
        });

        this.input.keyboard.on("keydown_SPACE", function(pointer){
            if(holding)
            {
                if(lookLeft)
                {
                    var shootY = -5;
                    var shootX = -10;
                    var spawnY = player.y - 40;
                    var spawnX = player.x - 30;
                }
                else
                {
                    var shootY = -5;
                    var shootX = 10;
                    var spawnY = player.y - 40;
                    var spawnX = player.x + 30;
                }
                // With knock back
                //this.matter.add.sprite(player.x, player.y, 'star').setPosition(player.x, player.y).setVelocityY(-5).setVelocityX(5).setFixedRotation();
                
                // Without knock back
                this.matter.add.sprite(spawnX, spawnY, 'star').setVelocityY(shootY).setVelocityX(shootX).setFixedRotation();//.setIgnoreGravity(true);
                holding = false;
                console.log("THROWING");
            }

            if(canGrab)
            {
                rune.destroy();
                canGrab = false;
                holding = true;
                console.log("GRABBING");
            }
            //if(holding === false && )
            
            // // this is where I wanted to remove the crate. Unfortunately I did not find a quick way to delete the Sprite
            // // bound to a Matter body, so I am setting it to invisible, then remove the body.
            // else{
            //     bodiesUnderPointer[0].gameObject.visible = false;
            //     this.matter.world.remove(bodiesUnderPointer[0])
            // }
        }, this);

        this.input.keyboard.on("keydown_A", function(pointer){
            player.setVelocityX(-5);
            lookLeft = true;
            player.flipX = true;
            tempx = playerVel.x;
            playerVel.x = tempx - 5;
        }, this);

        this.input.keyboard.on("keyup_A", function(pointer){
            player.setVelocityX(0);
            tempx = playerVel.x;
            playerVel.x = 0;
        }, this);

        this.input.keyboard.on("keydown_D", function(pointer){
            player.setVelocityX(5);
            lookLeft = false;
            player.resetFlip()
            tempx = playerVel.x;
            playerVel.x = tempx + 5;
        }, this);

        this.input.keyboard.on("keyup_D", function(pointer){
            player.setVelocityX(0);
            tempx = playerVel.x;
            playerVel.x = 0;
        }, this);

        this.input.keyboard.on("keydown_S", function(pointer){
            player.setVelocityY(5);
            tempy = playerVel.y;
            playerVel.y = tempy + 5;
        }, this);

        this.input.keyboard.on("keyup_S", function(pointer){
            player.setVelocityY(0);
            tempy = playerVel.y;
            playerVel.y = 0;
        }, this);

        this.input.keyboard.on("keydown_W", function(pointer){
            console.log(jump);
            if(jump === false)
            {
                player.setVelocityY(-10);
                tempy = playerVel.y;
                playerVel.y = tempy - 10;
                
                jump = true;
            }
        }, this);

        this.input.keyboard.on("keyup_W", function(pointer){
            player.setVelocityY(0);
            tempy = playerVel.y;
            playerVel.y = 0;
        }, this);
    }
</script>
</body>
</html>